on: [pull_request]
jobs:
  css-impact-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check CSS impact and comment
        run: |
          cat << 'EOF' > check_css.sh
          #!/bin/bash

          git fetch origin main

          # CSSファイルの変更からセレクターを抽出
          selectors=$(git diff origin/main...HEAD -- '*.css' | grep -oE '(\.[a-zA-Z][a-zA-Z0-9_-]*|#[a-zA-Z][a-zA-Z0-9_-]*)' | sort -u)

          if [ -z "$selectors" ]; then
            echo "No CSS selectors found in changes"
            exit 0
          fi

          # 変更されたセレクターが他のファイルで使用されているかをチェック
          impacted_files=""
          while IFS= read -r selector; do
            if [[ "$selector" =~ ^\. ]]; then
              # クラス名の場合
              class_name="${selector#.}"
              files=$(rg -l --word-regexp "$class_name" src/ 2>/dev/null || true)
            elif [[ "$selector" =~ ^# ]]; then
              # ID名の場合
              id_name="${selector#}"
              files=$(rg -l "id=[\"']$id_name[\"']" src/ 2>/dev/null || true)
            fi

            if [ -n "$files" ]; then
              impacted_files="$impacted_files\n- \`$selector\` → $(echo "$files" | tr '\n' ' ')"
            fi
          done <<< "$selectors"

          # 影響を受けるファイルがある場合はコメント
          if [ -n "$impacted_files" ]; then
            cat << 'COMMENT_EOF' | gh pr comment --body-file -
          ⚠️ **CSS Impact Check Warning**

          以下のCSSセレクターが変更されており、以下のファイルに影響を与える可能性があります：$impacted_files

          これらのファイルの動作に影響がないか確認してください。
          COMMENT_EOF
          else
            echo "No files are impacted by CSS changes"
          fi
          EOF

          chmod +x check_css.sh
          ./check_css.sh
