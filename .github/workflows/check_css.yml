name: CSS Impact Check

on: [pull_request]

permissions:
  pull-requests: write

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  css-impact-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 1. Check CSS file changes
        id: check-css
        run: |
          echo "ðŸ” Checking CSS file changes..."
          css_changes=$(git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} | grep '\.css$')

          if [ -z "$css_changes" ]; then
            echo "No CSS files changed"
            echo "css_changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Changed CSS files: $css_changes"
          echo "css_changed=true" >> $GITHUB_OUTPUT
          echo "css_files<<EOF" >> $GITHUB_OUTPUT
          echo "$css_changes" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: 2. Extract CSS selectors
        id: extract-selectors
        if: steps.check-css.outputs.css_changed == 'true'
        run: |
          echo "ðŸ“ Extracting CSS selectors from changes..."
          selectors=$(git diff ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} -- '*.css' |
                     grep -oE '(\.[a-zA-Z][a-zA-Z0-9_-]*|#[a-zA-Z][a-zA-Z0-9_-]*)' |
                     grep -v '^\.css$' | sort -u)

          if [ -z "$selectors" ]; then
            echo "No CSS selectors found in changes"
            echo "selectors_found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found selectors: $selectors"
          echo "selectors_found=true" >> $GITHUB_OUTPUT
          echo "selectors<<EOF" >> $GITHUB_OUTPUT
          echo "$selectors" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: 3. Check usage in src/ directory
        id: check-usage
        if: steps.extract-selectors.outputs.selectors_found == 'true'
        run: |
          echo "ðŸ”Ž Checking usage in src/ directory..."
          selectors="${{ steps.extract-selectors.outputs.selectors }}"
          impacted_files=""

          while IFS= read -r selector; do
            if [[ "$selector" =~ ^\. ]]; then
              class_name="${selector#.}"
              files=$(grep -l "class=[\"'].*$class_name.*[\"']" src/*.html 2>/dev/null || true)
            elif [[ "$selector" =~ ^# ]]; then
              id_name="${selector#}"
              files=$(grep -l "id=[\"']$id_name[\"']" src/*.html 2>/dev/null || true)
            fi

            if [ -n "$files" ]; then
              impacted_files="$impacted_files
            - \`$selector\` â†’ $(echo "$files" | tr '\n' ' ')"
            fi
          done <<< "$selectors"

          if [ -n "$impacted_files" ]; then
            echo "Files impacted: $impacted_files"
            echo "has_impact=true" >> $GITHUB_OUTPUT
            echo "impacted_files<<EOF" >> $GITHUB_OUTPUT
            echo "$impacted_files" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "No files are impacted by CSS changes"
            echo "has_impact=false" >> $GITHUB_OUTPUT
          fi


      - name: 4. Comment on PR
        if: steps.check-usage.outputs.has_impact == 'true'
        run: |
          cat > comment.md <<'EOF'
          âš ï¸ **CSS Impact Check Warning**

          ä»¥ä¸‹ã®CSSã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼ãŒå¤‰æ›´ã•ã‚Œã¦ãŠã‚Šã€ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å½±éŸ¿ã‚’ä¸Žãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼š

          ${{ steps.check-usage.outputs.impacted_files }}

          ã“ã‚Œã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å‹•ä½œã«å½±éŸ¿ãŒãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚
          EOF

          gh pr comment ${{ github.event.pull_request.number }} --body-file comment.md
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
